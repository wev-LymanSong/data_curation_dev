,cell_type,cell_title,role,codes
1,md,,description,"### ws_goods_stock
* ws_goods_stock_hourly"
2,md,,basic_info,"#### Basic Info 
* ìƒí’ˆíŒë§¤, ì¬ê³ í˜„í™© ë“± ìƒí’ˆì— ëŒ€í•œ ì „ë°˜ì ì¸ ë©”íƒ€ë°ì´í„°
* META TABLE
* DAILY OVERWRITE
* WIKI [https://bighitcorp.atlassian.net/wiki/spaces/OD/pages/2864185639/we+mart.ws+goods+stock]


###### history
|date|contributor|comments|
|----|----|----|
|2021-11-29|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|create mart table/ë°°ì¹˜ìƒì„±|
|2021-12-13|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|íŒŒí‹°ì…˜ í…Œì´ë¸”ë¡œ ë³€ê²½|
|2022-04-22|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|category_upr/lwr ë§¤í•‘ë¡œì§ ë³€ê²½|
|2022-05-04|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|category_upr/lwr ë§¤í•‘ì‹œ we_art_idëˆ„ë½ê²½ìš° ìˆ˜ì •|
|2022-05-26|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|fc_kit_ver ì¶”ê°€|
|2022-11-28|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|goods_cat light stick ì¶”ê°€|
|2023-01-10|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|goods_cat ë¡œì§ ìˆ˜ì •|
|2023-06-08|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|goods_cat: POD ì¶”ê°€|
|2023-09-21|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|bm_option ì¶”ê°€|
|2023-10-06|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|bm_option source settlement DBë¡œ ë³€ê²½|
|2024-01-02|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|í•­ëª© ì¶”ê°€ ë° ws_goods_stock_hourly ì½”ë“œ ë³‘í•©|
|2024-03-08|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|goods_cat='POD' ë¡œì§ ìˆ˜ì •|
|2024-03-08|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|í•­ëª© ì¶”ê°€ ```vertex_commodity_code_type,vertex_commodity_code_value,tax_type,is_digital_live,origins,origins_ctry_name,sale_start_at,sale_end_at,sale_reserv_history```|
|2024-10-07|ë°ì´í„°ë¶„ì„íŒ€ ì´í˜„ì§€|ì™¸ë¶€ íŒë§¤ë˜ëŠ” ìƒí’ˆì •ë³´(sale ë“±ë¡X) ë° ìŠ¤í”¼ì–´ ëŒ€ë¹„ pkë³€ê²½ ```sale_stock_id -> sale_stock_id, stock_id, goods_id, goods_option_id``` [ìœ„í‚¤](https://bighitcorp.atlassian.net/wiki/spaces/OD/pages/4065690124/2409+ws_goods_stock+key)|


###### Source Tables
* we_mart.ods_ws_goods
* we_mart.ods_ws_goods_stock
* we_mart.ods_ws_stock
* we_mart.ods_ws_goods_option
* we_mart.ods_ws_goods_option_group
* we_mart.ods_ws_sale
* we_mart.ods_ws_sale_stock
* we_mart.ods_ws_sale_fixed_price
* we_mart.ods_ws_goods_goods_category
* we_mart.ods_ws_goods_category
* we_mart.ods_ws_label_artist
* we_mart.ods_ws_goods_translation
* we_mart.ods_ws_common_info
* we_mart.ods_ws_shipping_group
* we_mart.ods_ws_delivery_service
* we_mart.ods_ws_trade_company
* membership.membership
* product.status_reservation
* product.status_reservation_item"
3,run,,etc, /Repos/databricks-prod/databricks/src/data_platform/dataflow/dataflow
4,md,,just_heading,#### FUNCTIONS
5,py,,code,"# hour, date êµ¬ë¶„
def get_key():
    mode = dbutils.widgets.get(""mode"")
    if mode == 'hourly':
        k = {'mode': mode
            , 'hour': dbutils.widgets.get(""target_hour"")
            , 'date': dbutils.widgets.get(""target_date"")}
    elif mode == 'daily':
        k = {'mode': mode
             , 'date': dbutils.widgets.get(""target_date"")}
    return(k)

# ì†ŒìŠ¤ ë·°í…Œì´ë¸” ìƒì„±
def cre_view_table(name):
    if get_key()['mode'] == 'daily':
        key = get_key()['date']
        source = 'wev_prod.we_mart.ods_ws_'
        tbl_name = f'''{source}{name}'''
        tbl = spark.read.table(tbl_name).where(f'''part_date = ""{key}""''') 
    elif get_key()['mode'] == 'hourly':
        source = 'wev_prod.weverseshop.'
        tbl_name = f'''{source}{name}'''
        tbl = spark.read.table(tbl_name)
        
    return tbl.createOrReplaceTempView(name)

# dataflow option, table ì†ì„± ì„ íƒ
def get_option():
  key_info = get_key()
  if key_info['mode'] == 'daily':
    key = key_info['date']
    key_date = key_info['date']
    o = {
    'date' : key_date, 
    'format':'delta',
    'mode': 'overwrite',
    'period': 'daily',
    'noti' : True
    }
    t = {
    'database' : 'we_mart',
    'table_name' : 'ws_goods_stock', 
    'service' : 'weverseshop',
    'partition' : ['part_date']
    }
  
  elif key_info['mode'] == 'hourly':
    key = key_info['hour']
    key_date = key_info['date']
    o = {
    'date' : key_date, 
    'format':'delta',
    'mode': 'overwrite',
    'period': 'hourly',
    'noti' : True
    }
    t = {
    'database' : 'we_mart',
    'table_name' : 'ws_goods_stock_hourly', 
    'service' : 'weverseshop'
    }
    
  return {'mode': key_info['mode']
          , 'key': key
          , 'key_date': key_date
          , 'option': o
          , 'table': t
          }
  
# ìµœì¢… dataframe
def fin_df(df_q, mode):
    if mode == 'daily':
        # daily ì—ì„œ dropí•  columns
        df = spark.sql(df_q)
        df = df.drop('precautions','notification_info','sale_title','sale_comment','part_hour')
    else:
        df = spark.sql(df_q)
    
    return df

# slack ë³´ë‚´ê¸°
import requests
DEBUG = False
def send_message_to_slack(target):

    if target == 'sale_stock_id_unique':
        message = ""ğŸš¨ we_mart.ws_goods_stock PK ì¤‘ë³µ ì¸ì… ìˆìŠµë‹ˆë‹¤.""

    slack_message = f""""""*{key} {message} *""""""
    slack_token = dbutils.secrets.get(scope=""slack"", key=""token"")
    slack_icon_emoji = ':official_check:'
    slack_user_name = 'Item Alert'

    if DEBUG: 
        slack_channel = ""#da-monitor-test""
    else: 
        slack_channel = '#da-monitor'

    response = requests.post('https://slack.com/api/chat.postMessage', {
        'token': slack_token,
        'channel': slack_channel,
        'icon_emoji': slack_icon_emoji,
        'username': slack_user_name,
        'text': slack_message
        })
    
    print (response.json())"
6,md,,just_heading,#### SETTINGS
7,py,,setting,"run_mode = dbutils.widgets.get(""run_mode"")
key = get_option()['key']
key_date = get_option()['key_date']
mode = get_option()['mode']

option = get_option()['option']
table = get_option()['table']

slack_token = dbutils.secrets.get(scope=""slack"", key=""slack-token"")
channel = dbutils.secrets.get(scope=""slack"", key=""analytics-channel"")

noti = {
  'channel' : channel,
  'token' : slack_token
}"
8,py,,code,"# ì´ìš© í…Œì´ë¸” (ods, prod êµ¬ë¶„ìš©)
table_list = [
	'goods'
,	'goods_stock'
,	'stock'
,	'goods_option'
,	'goods_option_group'
,	'sale'
,	'sale_stock'
,	'sale_fixed_price'
,	'goods_goods_category'
,	'goods_category'
,	'goods_translation'
,	'shipping_group'
,	'trade_company'
]

for name in table_list:
    cre_view_table(name)"
9,md,,just_heading,#### MAIN QUERY
10,py,,code,"df_q = f'''
select * except(seq) from (
select *, row_number() over(partition by part_date, sale_stock_id, stock_id, goods_id, goods_option_id order by goods_opt_cre_dt desc) as seq
from (

    select distinct
-- ID
    GDS.goods_id                                                                                                      as goods_id
    , SLE.sale_id                                                                                                     as sale_id
    , STK.stock_id                                                                                                    as stock_id
    , SLT.sale_stock_id                                                                                               as sale_stock_id
    , GGC.goods_upr_cat_id                                                                                            as goods_upr_cat_id
    , GGC.goods_lwr_cat_id                                                                                            as goods_lwr_cat_id
    , ART.we_art_id                                                                                                   as we_art_id
    , GDO.goods_option_id                                                                                             as goods_option_id
    , GOG.goods_option_group_id                                                                                       as goods_option_group_id
    , GOG.trade_company_id                                                                                            as trade_co_id
    , GDS.pickup_id                                                                                                   as pickup_id
    , SHIP.shipping_group_id                                                                                          as ship_group_id
    , SLE.delivery_service_domestic_id                                                                                as deliv_service_dom_id
    , SLE.delivery_service_overseas_id                                                                                as deliv_service_over_id
-- MEMBERSHIP ID
    , GDS.membership_id                                                                                               as fc_id
    , GDS.membership_category_id                                                                                      as fc_cat_id
-- SKU
    , GDS.goods_code                                                                                                  as goods_code
    , GDO.goods_option_code                                                                                           as goods_option_code
    , GDO.barcode                                                                                                     as barcode
    , GDO.wms_code                                                                                                    as wms_code
    , GDO.sap_code                                                                                                    as sap_code
    , GDO.wbs_code                                                                                                    as wbs_code
    , GOG.hscode                                                                                                      as hscode
-- POD
    , GDO.pod_option_sell_code                                                                                        as pod_option_sell_code
    , GDS.pod_template_code                                                                                           as pod_template_code
    , ''                                                                                                              as pod_resource_id
    , GOG.pod_product_code                                                                                            as pod_product_code
    , GDS.pod_product_type                                                                                            as pod_product_type
-- FINANCE
    , ST_CAT.bm_type                                                                                                  as bm_option
    , ST_CAT.settlement_category_name                                                                                 as settlement_category_name
    , ST_CAT.settlement_category_code                                                                                 as settlement_category_code
    , GOG.vertex_commodity_code_type
    , GOG.vertex_commodity_code_value
    , GOG.tax_type
-- CATEGORY
    , GDS.shop                                                                                                        as shop
    , ART.we_art_name                                                                                                 as we_art_name
    , trim(GCU.name)                                                                                                  as goods_upr_cat_name
    , trim(GCL.name)                                                                                                  as goods_lwr_cat_name
    , SLC_name.sale_upr_cat_name                                                                                      as sale_upr_cat_name
    , SLC_name.sale_lwr_cat_name                                                                                      as sale_lwr_cat_name
    , case when MEM.membership_id is not null then 'MEMBERSHIP'
            when GDS.goods_section = 'DIGITAL_TICKET' and GDS.goods_type = 'DIGITAL' and upper(trim(GCU.name)) like 'WEVERSE' then 'TVOD'
            when GDS.goods_section = 'DIGITAL_TICKET' and GDS.goods_type = 'DIGITAL' and upper(trim(GCU.name)) like 'LIVE' then 'LIVE_TICKET'
            when upper(GDS_name.goods_name) like '%LIGHT%STICK%' then 'LIGHT_STICK'
            when SLE.membership_benefit_type <> 'NORMAL' then SLE.membership_benefit_type
            when upper(GDS_name.goods_name) like '%MEMBERSHIP%' and GDO.goods_option_code like 'M%' and (upper(GDS_name.goods_name) like '%KIT%' or upper(GDO.name) like '%KIT%' or upper(GDO.name) like '%í‚¤íŠ¸%' or upper(GDO.name) like '%GIFT%') then 'KIT'
            when upper(GDS.goods_type) = 'POD' then 'POD'
            else 'OTHER'
        end                                                                                                           as goods_cat
    , GDS.goods_section                                                                                               as goods_section
    , GDS.goods_type                                                                                                  as goods_type
    , GDO.goods_option_type                                                                                           as goods_option_type
    , GDO.goods_receipt_type                                                                                          as goods_option_receipt_type
    , GOG.logistics_category                                                                                          as logi_cat
-- FC
    , FC.fc_ver                                                                                                       as fc_ver
    , case when GDS.goods_type = 'DELIVERY' and GDO.goods_option_code not rlike 'DIGITAL' and (GDS.goods_code rlike 'MS_|MBS_|MS[0-9]*$|MBS[0-9]*$' or GDS.goods_code in ('BPG0001','GL_FROMIS9WL')) then
            case when GDS.goods_code rlike 'KIT_V([0-9]*)$' then regexp_extract(GDS.goods_code, 'KIT_V([0-9]*)$', 1) -- ì¼ë°˜ í‚¤íŠ¸, í”„ë¦¬ë¯¸ì—„ í‚¤íŠ¸ êµ¬ë¶„
                when GDS.goods_code rlike 'MB([0-9]*)$' then regexp_extract(GDS.goods_code, 'MB([0-9]*)$', 1) -- MERCH BOX ë²„ì „ êµ¬ë¶„
                when GDS.goods_code rlike 'GT([0-9]*)$' then regexp_extract(GDS.goods_code, 'GT([0-9]*)$', 1) -- ë©¤ë²„ì‹­ êµ¬ë§¤ íŠ¹ì „ êµ¬ë¶„
                when SLE.sale_id in (154, 295, 673, 674, 675, 676, 806, 807, 7207, 8124) then '1'
                when ART.we_art_id in (4,5) and GDS.goods_code rlike 'KIT$' then '1'
                when GDS.goods_code rlike 'KIT$' then '2'
                else GDS_name.goods_name end
        end                                                                                                           as fc_kit_ver
-- BOM
    , case when GOC.component_sap_codes is not null then 1 else 0 end                                                 as is_bom_enabled
    , GOC.component_sap_codes                                                                                         as bom_sap_codes
-- NAME
    , GDS_name.goods_name                                                                                             as goods_name
    , GDO.name                                                                                                        as goods_option_name
    , GOG.name                                                                                                        as goods_option_group_name
    , SLT_name.sale_stock_name_ko                                                                                     as sale_stock_name_ko
    , SLT_name.sale_stock_name_ja                                                                                     as sale_stock_name_ja
    , SLT_name.sale_stock_name_en                                                                                     as sale_stock_name_en
    , SLT_name.release_name                                                                                           as release_name
-- PRICE
    , SLE.currency_code                                                                                               as currency_code
    , SLE.price                                                                                                       as original_price
    , SLE.sale_price                                                                                                  as sale_price
    , SLE.fixed_price                                                                                                 as is_fixed_price
    , case
        when SLE.fixed_price = 1 and SLE.currency_code = 'KRW' then SFP.fixed_sale_price 
        when SLE.fixed_price = 1 and SLE.currency_code = 'USD' then SFP.fixed_sale_price_USD
        when SLE.fixed_price = 1 and SLE.currency_code = 'JPY' then SFP.fixed_sale_price_JPY
        else SLE.sale_price
        end                                                                                                           as final_sale_price
    , case when SLE.fixed_price = 1 then SFP.fixed_sale_price else null end                                           as fixed_sale_price
    , case when SLE.fixed_price = 1 then SFP.fixed_sale_price_USD else null end                                       as fixed_sale_price_USD
    , case when SLE.fixed_price = 1 then SFP.fixed_sale_price_JPY else null end                                       as fixed_sale_price_JPY  
-- INFO
    , SLE.max_order_quantity                                                                                          as max_ord_qty
    , SLE.max_order_limit_type                                                                                        as max_ord_lim_type
    , SLE.max_order_limit_per_user                                                                                    as max_ord_lim_p_user
    , SLE.sale_alarm_percent                                                                                          as sale_alrarm_pc
    , SLE.min_order_quantity                                                                                          as min_ord_qty
    , SLE.usable_cart                                                                                                 as is_cart
    , SLE.taxable                                                                                                     as is_tax
    , SLE.include_tax_in_price                                                                                        as is_incl_tax
    , SLE.status                                                                                                      as sale_status
    , SLE.shop_tags                                                                                                   as shop_tags
    , SLE.digital_live                                                                                                as is_digital_live
    --   , GDS.goods_weight as weight1
    , GOG.weight                                                                                                      as weight
    , GOG.package_size                                                                                                as package_size
    , GOG.album_quantity                                                                                              as album_qty
    , case when GOG.mode = 1 then 'ì‚¬ì…' 
           when GOG.mode = 2 then 'ìœ„íƒ'
           else 'ê¸°íƒ€' end                                                                                             as business_type
    -- , case when ST_CAT.bm_type in ('GENERAL','GENERAL_PICK_UP','MEMBERSHIP_KIT_WEV','MEMBERSHIP_WEV') then 'ì‚¬ì…'
    --        when ST_CAT.bm_type in ('VOD_RS','LIVE_FEE_RS','POD','BY_FANS') then 'ìˆ˜ìµì‰ì–´'
    --        when ST_CAT.bm_type in ('CONSIGNMENT','PICK_UP','MEMBERSHIP_KIT','MEMBERSHIP_BOX','MEMBERSHIP_NEW','LIVE_FEE','DIGITAL') then 'ìœ„íƒ'
    --        end                                                                                                        as business_type2
    , STK.total_goods_receipt_amount                                                                                  as tot_goods_qty
    , STK.expected_amount                                                                                             as exp_goods_qty
    , STK.available_amount                                                                                            as real_goods_qty
    , STK.fake_amount                                                                                                 as fake_goods_qty
    , SLE.hide                                                                                                        as is_sale_hide
    , SLT.hide                                                                                                        as is_sale_stock_hide
    , SLT.restock_alarm                                                                                               as is_restock_alarm
    , case when SLE.icon_type = '[""ONLY""]' then 1 else 0 end                                                          as is_exclusive_icon
    , SLE.sold_out_icon                                                                                               as is_sold_out_icon_enabled
    , SLE.alarm_percent_to_show_sold_out_icon                                                                         as sold_out_alarm_pc
    , case when SLE.sold_out_icon = 1
                and SLT.remaining_quantity < ((SLE.alarm_percent_to_show_sold_out_icon / 100) * SLT.sale_quantity )
                and SLT.remaining_quantity > 0
                then 1 else 0 
                end                                                                                                   as will_be_sold_out
    , case when SLE.cash is not null then 1 else 0 end                                                                as is_fixed_cash_amount
    , SLE.cash                                                                                                        as fixed_cash_amount
    , SLE.delivery_date                                                                                               as deliv_dt
    , SLT.sale_quantity                                                                                               as sale_qty
    , SLT.remaining_quantity                                                                                          as avail_sale_qty
    , COMMON.title                                                                                                    as common_info
    , GOG.manufacturer                                                                                                as manufacturer
    , ORI.origins                                                                                                     as origins
    , ORI.origins_ctry_name                                                                                           as origins_ctry_name
    , TCOM.name                                                                                                       as trade_co_name
-- DELIVERY
    , SHIP.name                                                                                                       as ship_group_name
    , DSD.service_code                                                                                                as deliv_service_dom_code
    , DSD.display_name                                                                                                as deliv_service_dom_name
    , DSO.service_code                                                                                                as deliv_service_over_code
    , DSO.display_name                                                                                                as deliv_service_over_name
-- PICK-UP
    , PIC.name                                                                                                        as pickup_name
    , PIC.location_name                                                                                               as pickup_location
    , PIC.postal_code                                                                                                 as pickup_location_postal_code
-- OTHER SETTINGS
    , GDS_name.precautions                                                                                            as precautions
    , GDS_name.notification_info                                                                                      as notification_info
    , SLE_t.title                                                                                                     as sale_title
    , SLE_t.comment                                                                                                   as sale_comment
-- SALE DATE/RESERVATION
    , SLE.sale_start_at                                                                                               as sale_start_at
    , SLE.sale_end_at                                                                                                 as sale_end_at
    , sort_array(REV.sale_reserv)                                                                                     as sale_reserv_history
-- DATE
    , GDS.created_at                                                                                                  as goods_cre_dt
    , STK.updated_at                                                                                                  as stock_upd_dt
    , SLE.created_at                                                                                                  as sale_cre_dt
    , SLE.updated_at                                                                                                  as sale_upd_dt
    , SLT.updated_at                                                                                                  as sale_stock_upd_dt
    , GDO.created_at                                                                                                  as goods_opt_cre_dt
    , GDO.updated_at                                                                                                  as goods_opt_upd_dt
    , timestamp(current_timestamp() + interval '9' hour)                                                              as run_timestamp
    , '{key_date}'                                                                                                    as part_date
    , '{key}'                                                                                                         as part_hour

    from goods_option as GDO
    left join goods_option_group as GOG on GDO.goods_option_group_id = GOG.goods_option_group_id
    left join stock as STK on GDO.goods_option_id = STK.goods_option_id
    left join goods_stock as GDT on STK.stock_id = GDT.stock_id
    left join goods as GDS on GDT.goods_id = GDS.goods_id
    left join sale as SLE on GDS.goods_id = SLE.goods_id
    left join sale_stock as SLT on SLE.sale_id = SLT.sale_id and GDO.goods_option_id = SLT.goods_option_id

-- ORIGINS
    left join 
    (
        select goods_option_group_id, collect_list(ctry_code) as origins, collect_list(ctry_name_en) as origins_ctry_name
        from (
        select a.*, b.ctry_name_en
        from (
            select distinct goods_option_group_id, explode(regexp_extract_all(upper(origins), r'([A-Z]+)')) as ctry_code
            from goods_option_group
        ) a
        left join wev_prod.we_meta.we_country b on a.ctry_code = b.ctry_code
        distribute by a.ctry_code
        )
        group by 1
    ) as ORI on GDO.goods_option_group_id = ORI.goods_option_group_id
-- FIXED PRICE SOURCE
    left join 
    (
        select 
        FIX.sale_id
        , max(case when FIX.currency_code = 'KRW' then FIX.fixed_sale_price else NULL end) as fixed_sale_price
        , max(case when FIX.currency_code = 'USD' then FIX.fixed_sale_price else NULL end) as fixed_sale_price_USD
        , max(case when FIX.currency_code = 'JPY' then FIX.fixed_sale_price else NULL end) as fixed_sale_price_JPY
        from sale_fixed_price as FIX
        inner join 
        (
        select 
        sale_id
        , currency_code
        , max(updated_at) as updated_at 
        from sale_fixed_price
        group by sale_id, currency_code
        ) as C1 on C1.sale_id = FIX.sale_id and C1.currency_code = FIX.currency_code and C1.updated_at = FIX.updated_at 
        group by FIX.sale_id
    ) as SFP on SLE.sale_id = SFP.sale_id
-- CATEGORY SOURCE 
    left join 
    (
        select distinct
        a.goods_id
        , min(case when b.parent_id < 0 then a.goods_category_id end) as goods_upr_cat_id
        , max(case when b.parent_id > 0 then a.goods_category_id end) as goods_lwr_cat_id
        from goods_goods_category a
        left join goods_category b on a.goods_category_id = b.goods_category_id
        group by a.goods_id
    ) as GGC on GDS.goods_id = GGC.goods_id
    left join 
    (
        select row_number()over(partition by goods_category_id order by created_at desc) as num, *
        from goods_category
    ) as GCU on GGC.goods_upr_cat_id = GCU.goods_category_id and GCU.num = 1
    left join 
    (
        select row_number()over(partition by goods_category_id order by created_at desc) as num, *
        from goods_category
    ) as GCL on GGC.goods_lwr_cat_id = GCL.goods_category_id and GCL.num = 1  
    left join we_mart.we_artist as ART 
            on case when GCU.label_artist_id is null then GCL.label_artist_id = ART.ws_art_id else GCU.label_artist_id = ART.ws_art_id end
-- NAME SOURCE 
    left join 
    (
        select *, row_number() over(partition by goods_id, shop order by updated_at desc) as seq
        from (
            select distinct
            goods_id
            , case
                when language = 'ko' then 'GL'
                when language = 'en' then 'US'
                when language = 'ja' then 'JP'
                end as shop
            , name as goods_name
            , precautions
            , notification_info
            , updated_at
            from goods_translation
        )
    ) as GDS_name on GDS.goods_id = GDS_name.goods_id and GDS.shop = GDS_name.shop and GDS_name.seq = 1
    left join
    (
        select 
        *
        , max(case when language ='ko' then name end)over(partition by sale_stock_id) as sale_stock_name_ko
        , max(case when language ='ja' then name end)over(partition by sale_stock_id) as sale_stock_name_ja
        , max(case when language ='en' then name end)over(partition by sale_stock_id) as sale_stock_name_en
        from weverseshop.sale_stock_name
    ) as SLT_name on SLT_name.sale_stock_id = SLT.sale_stock_id and SLT_name.language = case when SLE.shop = 'GL' then 'ko' when SLE.shop = 'US' then 'en' when SLE.shop = 'JP' then 'ja' end 
    left join weverseshop.common_info as COMMON on SLE.common_info_id = COMMON.common_info_id
-- SHIP/DELIVERY SOURCE
    left join shipping_group as SHIP on SLE.shipping_group_id = SHIP.shipping_group_id
    left join weverseshop.delivery_service as DSD on SLE.delivery_service_domestic_id = DSD.delivery_service_id
    left join weverseshop.delivery_service as DSO on SLE.delivery_service_overseas_id = DSO.delivery_service_id
-- TRADE COMPANY
    left join trade_company as TCOM on GOG.trade_company_id = TCOM.trade_company_id
-- MEMBERSHIP
    left join membership.membership as MEM on GDO.goods_option_code = MEM.membership_code
-- BM_OPTION
    left join wev_prod.settlement.settlement_category ST_CAT on ST_CAT.settlement_category_id = GOG.settlement_category_id
-- SALE DISPLAY NAME
    left join
    (
        select 
        a.sale_id
        , collect_set(trim(b.name)) as sale_upr_cat_name
        , collect_set(case when trim(c.name) is null then trim(b.name) else trim(c.name) end) as sale_lwr_cat_name
        from weverseshop.artist_sale a
        left join weverseshop.goods_category b on b.goods_category_id = a.parent_goods_category_id
        left join weverseshop.goods_category c on c.goods_category_id = a.child_goods_category_id
        group by 1
    ) as SLC_name ON SLE.sale_id = SLC_name.sale_id
-- BOM
    left join
    (
        select distinct 
        a.goods_option_id
        , collect_list(b.sap_code) as component_sap_codes
        from weverseshop.goods_option_component as a 
        left join weverseshop.goods_option as b on a.goods_option_child_id = b.goods_option_id
        group by 1
    ) as GOC ON GOC.goods_option_id = GDO.goods_option_id 
    left join weverseshop.sale_translation as SLE_t on SLE_t.sale_id = SLE.sale_id and SLE_t.language = case when SLE.shop = 'GL' then 'ko' when SLE.shop = 'US' then 'en' when SLE.shop = 'JP' then 'ja' end 
    left join weverseshop.pickup PIC on GDS.pickup_id = PIC.pickup_id
-- FC
    left join 
    (
        select   
        distinct
        benefit_code
        ,case when benefit_code rlike r'_V([0-9]*)$' then regexp_extract(benefit_code, r'_(V[0-9]*)$', 1) 
            when benefit_code rlike r'MB([0-9]*)$' then concat('V',floor((regexp_extract(benefit_code, r'MB([0-9]*)$', 1) + 7)/4))
            end as fc_ver
        ,case when benefit_code rlike r'_V([0-9]*)$' then regexp_extract(benefit_code, r'_V([0-9]*)$', 1) 
            when benefit_code rlike r'MB([0-9]*)$' then floor(regexp_extract(benefit_code, r'MB([0-9]*)$', 1))
            end as fc_kit_ver
        ,case   when benefit_code = 'GL_BTSMBS_MB1' then 'GL_BTMS_MB1'
                when benefit_code = 'GL_BTSMBS_MB2' then 'GL_BTMS_MB2'
                when benefit_code = 'GL_BTSMBS_MB3' then 'GL_BTMS_MB3'
                when benefit_code = 'GL_BTSMBS_MB4' then 'GL_BTMS_MB4'
                when benefit_code = 'US_BTSMBS_MB1' then 'US_BTMS_MB1'
                when benefit_code = 'US_BTSMBS_MB2' then 'US_BTMS_MB2'
                when benefit_code = 'US_BTSMBS_MB3' then 'US_BTMS_MB3'
                when benefit_code = 'US_BTSMBS_MB4' then 'US_BTMS_MB4'
                when benefit_code = 'JP_BTSMBS_MB1' then 'JP_BTMS_MB1'
                when benefit_code = 'JP_BTSMBS_MB2' then 'JP_BTMS_MB2'
                when benefit_code = 'JP_BTSMBS_MB3' then 'JP_BTMS_MB3'
                when benefit_code = 'JP_BTSMBS_MB4' then 'JP_BTMS_MB4'
                when benefit_code = 'GL_BTSMBS_KIT_V2' then 'GL_BTSMS_KIT'
                when benefit_code = 'US_BTSMBS_KIT_V2' then 'US_BTSMS_KIT'
                when benefit_code = 'JP_BTSMBS_KIT_V2' then 'JP_BTSMS_KIT'
                when benefit_code = 'GL_EHMBS_KIT_V1' then 'GL_EHMBS_KIT'
                when benefit_code = 'US_EHMBS_KIT_V1' then 'US_EHMBS_KIT'
                when benefit_code = 'JP_EHMBS_KIT_V1' then 'JP_EHMBS_KIT'
                when benefit_code = 'GL_SVTMBS_KIT_V1' then 'GL_SVTMBS_KIT'
                when benefit_code = 'GL_TXTMBS_KIT_V2' then 'GL_TXTMBS_V2_KIT'
                when benefit_code = 'US_TXTMBS_KIT_V2' then 'US_TXTMBS_V2_KIT'
                when benefit_code = 'JP_TXTMBS_KIT_V2' then 'JP_TXTMBS_V2_KIT'
                when benefit_code = 'GL_BPG0001' then 'BPG0001'
                when benefit_code = 'GL_NJSMBS_KIT_PREMIUM_V1' then 'GL_NEWJEANSMBSPREMIUM_KIT_V1'
                when benefit_code = 'GL_NJSMBS_KIT_GENERAL_V1' then 'GL_NEWJEANSMBSGENERAL_KIT_V1'
                when benefit_code = 'JP_NJSMBS_KIT_GENERAL_V1' then 'JP_NEWJEANSMBSGENERAL_KIT_V1'
                when benefit_code = 'JP_NJSMBS_KIT_PREMIUM_V1' then 'JP_NEWJEANSMBSPREMIUM_KIT_V1'
                else benefit_code end as goods_code
        from wev_prod.membership.benefit a
        left join wev_prod.membership.membership_benefit b on b.benefit_id = a.benefit_id
        left join wev_prod.membership.membership c on c.membership_id = b.membership_id
        left join wev_prod.membership.artist_shop_version d on d.artist_shop_version_id = c.artist_shop_version_id
        left join wev_prod.membership.membership_version e on e.membership_version_id = d.membership_version_id
        where a.benefit_id not in (75,76,77) -- TEST ì œì™¸
        and a.benefit_kind != 'GIFT'
    ) as FC on GDS.goods_code = FC.goods_code
-- SALE RESERVATION
    left join 
    (
        select sale_id
        , collect_list(named_struct('reserv_dt', reserv_dt, 'hide', tobe_status:hide, 'sale_status', tobe_status:saleStatus, 'reserv_status', status)) as sale_reserv
        from (
        select distinct b.*
        , a.target_id as sale_id
        , from_unixtime(b.reservation_at) + interval 9 hours as reserv_dt
        from wev_prod.product.status_reservation_item a
        left join wev_prod.product.status_reservation b on a.status_reservation_id = b.status_reservation_id
        distribute by b.status_reservation_id
        )
        group by 1
    ) REV on SLE.sale_id = REV.sale_id
)
)
where seq = 1
'''
df = fin_df(df_q, mode)"
11,md,,just_heading,#### RUN
12,py,,code,"# ì¤‘ë³µ ê°’ í™•ì¸
check = df.groupBy('sale_stock_id','stock_id','goods_id','goods_option_id').count()
check_cnt = check.where('count > 1 and sale_stock_id || stock_id || goods_id || goods_option_id is not null').count()

# RUN MAIN QUERY
if check_cnt > 1:
    send_message_to_slack('sale_stock_id_unique')
else:
    b = Dataflow(run_mode=run_mode, notifier=noti)
    b.run(dataframe=df, table_info=table, option=option, buckets=['databricks'])"
13,md,,just_heading,#### Appendix
14,md,,just_heading,##### create query
15,py,,code,"""""""
create = '''
CREATE TABLE IF NOT EXISTS we_mart.ws_goods_stock (
	goods_id	bigint	comment	'ìƒí’ˆ id'
,	sale_id	bigint	comment	'íŒë§¤ id'
,	stock_id	bigint	comment	'ì…ê³  id'
,	sale_stock_id	bigint	comment	'íŒë§¤ìƒí’ˆ ì˜µì…˜ id'
,	goods_upr_cat_id	bigint	comment	'ìƒìœ„ì¹´í…Œê³ ë¦¬ id'
,	goods_lwr_cat_id	bigint	comment	'í•˜ìœ„ì¹´í…Œê³ ë¦¬ id'
,	we_art_id	int	comment	'ì•„í‹°ìŠ¤íŠ¸ id'
,	goods_option_id	bigint	comment	'ìƒí’ˆ ì˜µì…˜ id'
,	goods_option_group_id	bigint	comment	'ìƒí’ˆ ì˜µì…˜ ê·¸ë£¹ id'
,	trade_co_id	bigint	comment	'ê±°ë˜ì²˜ id'
,	pickup_id	bigint	comment	'í˜„ì¥ìˆ˜ë ¹ id'
,	ship_group_id	bigint	comment	'ë°°ì†¡ê·¸ë£¹ id'
,	deliv_service_dom_id	bigint	comment	'êµ­ë‚´ ë°°ì†¡ì‚¬ id'
,	deliv_service_over_id	bigint	comment	'í•´ì™¸ ë°°ì†¡ì‚¬ id'
,	fc_id	bigint	comment	'ë©¤ë²„ì‹­ id'
,	fc_cat_id	bigint	comment	'ë©¤ë²„ì‹­ ì¹´í…Œê³ ë¦¬ id'
,	goods_code	string	comment	'ìƒí’ˆ code'
,	goods_option_code	string	comment	'ìƒí’ˆ ì˜µì…˜ code'
,	barcode	string	comment	'ë°”ì½”ë“œ'
,	wms_code	string	comment	'WMS_ID'
,	sap_code	string	comment	'SAP ìì¬ì½”ë“œ'
,	wbs_code	string	comment	'WBS ì½”ë“œ'
,	hscode	string	comment	'HS Code'
,	pod_option_sell_code	string	comment	'POD ìƒí’ˆ ì˜µì…˜ íŒë§¤ ì½”ë“œ'
,	pod_template_code	string	comment	'POD í…œí”Œë¦¿ ì½”ë“œ'
,	pod_resource_id	string	comment	'POD ë¦¬ì†ŒìŠ¤ ID'
,	pod_product_code	string	comment	'POD ìƒí’ˆ ì½”ë“œ'
,	pod_product_type	string	comment	'POD ìƒí’ˆ ìœ í˜•'
,	bm_option	string	comment	'bm_option'
,	settlement_category_name	string	comment	'ì •ì‚° ì¹´í…Œê³ ë¦¬ëª…'
,	settlement_category_code	string	comment	'ì •ì‚° ì¹´í…Œê³ ë¦¬ì½”ë“œ'
, 	vertex_commodity_code_type string comment 'Vertex ìƒí’ˆì½”ë“œíƒ€ì…'
, 	vertex_commodity_code_value string comment 'Vertex ìƒí’ˆì½”ë“œ'
, 	tax_type string comment 'ì„¸ê¸ˆêµ¬ë¶„'
,	shop	string	comment	'shop'
,	we_art_name	string	comment	'ì•„í‹°ìŠ¤íŠ¸ëª…'
,	goods_upr_cat_name	string	comment	'ìƒìœ„ì¹´í…Œê³ ë¦¬ëª…'
,	goods_lwr_cat_name	string	comment	'í•˜ìœ„ì¹´í…Œê³ ë¦¬ëª…'
,	sale_upr_cat_name	string	comment	'ì•±ë…¸ì¶œ ìƒìœ„ì¹´í…Œê³ ë¦¬'
,	sale_lwr_cat_name	string	comment	'ì•±ë…¸ì¶œ í•˜ìœ„ì¹´í…Œê³ ë¦¬'
,	goods_cat	string	comment	'ìƒí’ˆêµ¬ë¶„ (ë§ˆíŠ¸ë§Œë“¤ë©° ìƒì„±)'
,	goods_section	string	comment	'ìƒí’ˆêµ¬ë¶„'
,	goods_type	string	comment	'ìƒí’ˆ ìœ í˜• (ë°°ì†¡ìƒí’ˆ, ë””ì§€í„¸ìƒí’ˆ)'
,	goods_option_type	string	comment	'ìƒí’ˆ ì¢…ë¥˜ (ìœ í˜•, ë¬´í˜•)'
,	goods_option_receipt_type	string	comment	'ì…ê³  ìœ í˜• (NORMAL, SET, RANDOM)'
,	logi_cat	string	comment	'ë¬¼ë¥˜ ì¹´í…Œê³ ë¦¬'
,	fc_ver string comment 'FC ë²„ì „'
,	fc_kit_ver	string	comment	'í‚¤íŠ¸ ë²„ì „'
,	is_bom_enabled	int	comment	'BOM ìœ ë¬´'
,	bom_sap_codes	array<string>	comment	'BOM sap_codeëª¨ìŒ(array)'
,	goods_name	string	comment	'ìƒí’ˆëª…'
,	goods_option_name	string	comment	'ìƒí’ˆ ì˜µì…˜ëª…'
,	goods_option_group_name	string	comment	'ìƒí’ˆ ì˜µì…˜ ê·¸ë£¹ëª…'
,	sale_stock_name_ko	string	comment	'sale_stockëª…(í•œ)'
,	sale_stock_name_ja	string	comment	'sale_stockëª…(ì¼)'
,	sale_stock_name_en	string	comment	'sale_stockëª…(ì˜)'
,	release_name	string	comment	'ìƒí’ˆì¶œí•˜ëª…'
,	currency_code	string	comment	'í†µí™”'
,	original_price	double	comment	'ìƒí’ˆ ì •ê°€'
,	sale_price	double	comment	'íŒë§¤ê°€ê²©'
,	is_fixed_price	tinyint	comment	'ê³ ì •ê°€ê²© ì—¬ë¶€'
,	final_sale_price	double	comment	'ìµœì¢… íŒë§¤ê°€ê²© (ê³ ì •ê°€ê²©ì¸ ê²½ìš° ê³ ì •ê°€ê²©ì„ íŒë§¤ê°€ê²©ìœ¼ë¡œ í•¨)'
,	fixed_sale_price	double	comment	'ê³ ì • íŒë§¤ê°€'
,	fixed_sale_price_USD	double	comment	'ê³ ì • íŒë§¤ê°€ (USD)'
,	fixed_sale_price_JPY	double	comment	'ê³ ì • íŒë§¤ê°€ (JPY)'
,	max_ord_qty	int	comment	'ìµœëŒ€ êµ¬ë§¤ê°€ëŠ¥ìˆ˜ëŸ‰'
,	max_ord_lim_type	string	comment	'ìµœëŒ€ êµ¬ë§¤ìˆ˜ëŸ‰ ì¡°ê±´ê°’'
,	max_ord_lim_p_user	tinyint	comment	'ìµœëŒ€ êµ¬ë§¤ìˆ˜ëŸ‰ íšŒì›ë³„ ì£¼ë¬¸ì œì•½ ì—¬ë¶€'
,	sale_alrarm_pc	tinyint	comment	'ì¬ê³ ì•Œë¦¼ % (íŒë§¤ë“±ë¡ ìˆ˜ëŸ‰ì˜ n%ê°€ ë˜ì—ˆì„ ê²½ìš° ì•ŒëŒë°›ê¸°)'
,	min_ord_qty	int	comment	'ìµœì†Œ ì£¼ë¬¸ê°€ëŠ¥ìˆ˜ëŸ‰'
,	is_cart	tinyint	comment	'ì¹´íŠ¸ì‚¬ìš©ì—¬ë¶€'
,	is_tax	tinyint	comment	'íŒë§¤ì„¸ì ìš© ì—¬ë¶€'
,	is_incl_tax	tinyint	comment	'ìƒí’ˆê°€ê²©ì— íŒë§¤ì„¸í¬í•¨ ì—¬ë¶€'
,	sale_status	string	comment	'íŒë§¤ ìƒíƒœ'
,	shop_tags	string	comment	'ìƒµ íƒœê·¸'
, 	is_digital_live tinyint comment 'ë””ì§€í„¸ ë¼ì´ë¸Œ ìƒí’ˆ ì—¬ë¶€'
,	weight	double	comment	'ì¤‘ëŸ‰'
,	package_size	string	comment	'íŒ¨í‚¤ì§€ ì‚¬ì´ì¦ˆ'
,	album_qty	int	comment	'ì•¨ë²” ìˆ˜ëŸ‰'
,	business_type	string	comment	'ê±°ë˜ë°©ì‹ (1:ì‚¬ì…, 2:ìœ„íƒ)'
,	tot_goods_qty	int	comment	'ì´ ì…ê³  ìˆ˜ëŸ‰ (ëˆ„ì )'
,	exp_goods_qty	int	comment	'ì…ê³  ìš”ì²­í•œ ìˆ˜ëŸ‰'
,	real_goods_qty	int	comment	'ì‹¤ì œ ì…ê³ ëœ ìˆ˜ëŸ‰'
,	fake_goods_qty	int	comment	'ê°€ì…ê³  ìˆ˜ëŸ‰'
,	is_sale_hide	tinyint	comment	'ë…¸ì¶œì—¬ë¶€ (íŒë§¤ ìƒíƒœì˜ ë”ë¯¸)'
,	is_sale_stock_hide	tinyint	comment	'íŒë§¤ ì˜µì…˜ ë…¸ì¶œ ì—¬ë¶€'
,	is_restock_alarm	tinyint	comment	'ì¬ì…ê³ ì•Œë¦¼ ì„¤ì • ì—¬ë¶€'
,	is_exclusive_icon	int	comment	'ë‹¨ë…íŒë§¤ ì—¬ë¶€'
,	is_sold_out_icon_enabled	tinyint	comment	'ì†”ë“œì•„ì›ƒ ê²½ê³  ë…¸ì¶œ ì„¤ì •'
,	sold_out_alarm_pc	tinyint	comment	'ì†”ë“œì•„ì›ƒ ê²½ê³  ë…¸ì¶œ percent(%)'
,	will_be_sold_out	int	comment	'ì†”ë“œì•„ì›ƒ ê²½ê³ ì¤‘'
,	is_fixed_cash_amount	int	comment	'ê°œë³„ ìºì‹œ ì„¤ì • ì‚¬ìš©'
,	fixed_cash_amount	double	comment	'ì„¤ì • ìºì‹œ(KRW)'
,	deliv_dt	timestamp	comment	'ë°°ì†¡ ì˜ˆì •ì¼ì‹œ'
,	sale_qty	int	comment	'íŒë§¤ìˆ˜ëŸ‰'
,	avail_sale_qty	int	comment	'íŒë§¤ê°€ëŠ¥ìˆ˜ëŸ‰'
,	common_info	string	comment	'êµí™˜/ë°˜í’ˆ ê³µí†µì •ë³´'
,	manufacturer	string	comment	'ì œì¡°ì‚¬'
, 	origins array<string> comment 'ì›ì‚°ì§€(êµ­ê°€ì½”ë“œ)'
, 	origins_ctry_name array<string> comment 'ì›ì‚°ì§€(êµ­ê°€ëª…-ì˜ë¬¸)'
,	trade_co_name	string	comment	'ê±°ë˜ì²˜'
,	ship_group_name	string	comment	'ë°°ì†¡ê·¸ë£¹ ì´ë¦„'
,	deliv_service_dom_code	string	comment	'êµ­ë‚´ ë°°ì†¡ì‚¬ ì½”ë“œ'
,	deliv_service_dom_name	string	comment	'êµ­ë‚´ ë°°ì†¡ì‚¬ ì´ë¦„'
,	deliv_service_over_code	string	comment	'í•´ì™¸ ë°°ì†¡ì‚¬ ì½”ë“œ'
,	deliv_service_over_name	string	comment	'í•´ì™¸ ë°°ì†¡ì‚¬ ì´ë¦„'
,	pickup_name	string	comment	'í”½ì—… ëª…'
,	pickup_location	string	comment	'í”½ì—… ì¥ì†Œ'
,	pickup_location_postal_code	string	comment	'í”½ì—… ì¥ì†Œ ìš°í¸ë²ˆí˜¸'
,	sale_start_at timestamp comment 'íŒë§¤ ì‹œì‘ì¼'
, 	sale_end_at timestamp comment 'íŒë§¤ ì¢…ë£Œì¼'
, 	sale_reserv_history array<struct<reserv_dt:string,hide:string,sale_status:string,reserv_status:string>> comment 'íŒë§¤ ìƒíƒœ ì˜ˆì•½ì •ë³´'
,	goods_cre_dt	timestamp	comment	'ìƒí’ˆë“±ë¡ì¼'
,	stock_upd_dt	timestamp	comment	'ì¬ê³ ì—…ë°ì´íŠ¸ì¼'
,	sale_cre_dt	timestamp	comment	'íŒë§¤ë“±ë¡ì¼'
,	sale_upd_dt	timestamp	comment	'íŒë§¤ ì—…ë°ì´íŠ¸ì¼'
,	sale_stock_upd_dt	timestamp	comment	'íŒë§¤ì¬ê³  ì—…ë°ì´íŠ¸ì¼'
,	run_timestamp	timestamp
,	part_date	string	comment	'íŒŒí‹°ì…˜ ì¼ì'

--### ws_goods_stock_hourly í…Œì´ë¸” ì¶”ê°€ í•­ëª©
-- ,	precautions	string	comment	'ìƒí’ˆìœ í˜•ì‚¬í•­'
-- ,	notification_info	string	comment	'ìƒí’ˆê³ ì§€ì •ë³´'
-- ,	sale_title	string	comment	'íŒë§¤ íƒ€ì´í‹€'
-- ,	sale_comment	string	comment	'íŒë§¤ ì½”ë©˜íŠ¸'
-- ,	part_hour	string	comment	'íŒŒí‹°ì…˜ ì‹œê°„'

)
using DELTA
partitioned by (part_date)
comment 'ìœ„ë²„ìŠ¤ìƒµ ìƒí’ˆ ë©”íƒ€ì •ë³´ (ì¬ê³ , íŒë§¤ì •ë³´ í¬í•¨)'
'''
# spark.sql(create)
"""""""
16,md,,just_heading,##### REFERENCE (WAREHOUSE)
17,py,,code,"""""""
%sql
--   -- WAREHOUSE SOURCE
--   left join 
--   (
--     select distinct
--     STH0.goods_option_id
--     , STH0.memo
--     , STH0.import_due_date
--     , STH0.status as warehouse_status
--     , STH0.logistics_category
--     , WAR.name as warehouse_name
--     from weverseshop.stock_history as STH0
--     left join weverseshop.warehouse as WAR on STH0.warehouse_id = WAR.warehouse_id
--     inner join 
--     (
--       select 
--       goods_option_id
--       , max(created_at) as created_at
--       , max(memo) as memo
--       from weverseshop.stock_history
--       group by goods_option_id
--     ) as STH1 on STH0.goods_option_id = STH1.goods_option_id and STH0.created_at = STH1.created_at and STH0.memo = STH1.memo
--   ) as STH2 on STK.goods_option_id = STH2.goods_option_id
"""""""
18,py,,code,"# dbutils.widgets.text('mode', 'daily')
# dbutils.widgets.text('target_date', '2024-05-01')
# dbutils.widgets.text('target_hour', '13')
# dbutils.widgets.text('run_mode', 'prod')
"
