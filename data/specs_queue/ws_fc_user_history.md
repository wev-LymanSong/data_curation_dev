
we_mart.ws_fc_user_history
==========================

# BASIC INFO

|**About**| 담당자 수기 입력 필요 |
| :--- | :--- |
|**Database**|**we_mart**|
|**Table Type**|MART PRIMARY|
|**Partitioned by**|`part_art_id`, `part_date`|
|**Created/ Last Updated At**|2021-11-29 / 2024-08-05|
|**Created By**|박상민|
|**Last Updated By**|윤상혁|
|**Collaborators**|윤상혁[34], 이현지[2], 구민서[1], 박상민[1]|
  
#### Change History
|**Date**|**By**|**LINK**|
| :--- | :--- | :--- |
|2021-11-29|박상민|[PR](https://github.com/benxcorp/databricks/commit/8dc809154614d40353684e2d2023adee4ec47cef)|
|2021-12-17|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/652ef83b3a4e225efa4353dc1ecd8c881eaa98be)|
|2021-12-20|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/8c41b3c8d53490819b3cd626f567417989cef051)|
|2022-03-04|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/5de19eaf314b5fd5c7f94b7dabe62bc68d110bf3)|
|2022-05-13|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/4aa494fff8b0891738bec4270fdb26f71074683e)|
|2022-06-21|이현지|[PR](https://github.com/benxcorp/databricks/commit/4de5d0a511e4aea4096e4e68957053d954f979fb)|
|2022-06-21|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/d07ae742b49b4163f76dd32a971771c22f2b2555)|
|2022-08-19|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/a82d03beb7252432a46d7164f1069bc88afe0018)|
|2022-08-19|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/b5af925a768f04810481d743f2e417b3b2afe734)|
|2022-08-23|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/8ccc94a120419b31b2d74857921df940eb1f5033)|
|2022-08-24|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/871a7138484ad41a348c303a24a8a87c9fc27b81)|
|2022-08-30|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/4bbe0e24e8be0f337ce24991b7622f05eabb9aa1)|
|2022-10-04|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/a31e0649bb87b99eecefaa1967b43a3e68825b15)|
|2022-10-05|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/a0bd7450977a7100cb954f70581fa55ff97b98b0)|
|2022-10-14|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/c0f3d80ab02475bd28d2f87c43604934279294e1)|
|2022-10-17|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/e3de70e5a7a5d3078bca59b58c8d51f2e56679ef)|
|2022-10-18|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/6bbc236af5492ff1fbf654fa2000e0854df17910)|
|2022-12-09|구민서|[PR](https://github.com/benxcorp/databricks/commit/bd183779c84e616084e05627330a1c8b98ca44bd)|
|2023-05-24|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/28e1e902aef56aae5c4b0bac8d2b5283fa318f13)|
|2023-05-24|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/4d8435e56fe83ab5bb00ad700576e3578ff11f3d)|
|2023-06-16|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/f24519f1390062c7405b9863081301383464861e)|
|2023-09-13|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/900aba86a8832ff6bc1a7cacda3706b3a2c3e261)|
|2023-09-13|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/ad353a528ede2b2465d2cb67d7f97aacc8c7a3ae)|
|2023-09-14|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/eed6ab5484556a965f56c9be68eab48c82909c66)|
|2023-09-15|이현지|[PR](https://github.com/benxcorp/databricks/commit/0d97f79144b048f974560da403f0240da6925e88)|
|2023-09-15|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/6a86c922335a95557baf5c403622e4473e73f3b5)|
|2023-09-22|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/ece1022226d23f86f2c4a33662480e94555204c2)|
|2023-09-25|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/22797044f0117b386d6e0838969df94e52241472)|
|2023-09-25|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/3329d287b8c84766de81b8aea2a4eb5d15d87cd9)|
|2023-09-26|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/8070c9cbb22b4dcffbfed79a495870e4125a1391)|
|2023-09-27|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/6399000bd1a384e9a035498ee6031b03ebd1e776)|
|2024-01-22|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/80884d146e8b55218c8104f48e71facd5a42c3e0)|
|2024-03-20|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/3f08ce4d6aed1bca75a7df13a2bcce930c7e54eb)|
|2024-03-20|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/dfb78716b8902da2faf92569ee2899ce4dbd8290)|
|2024-03-28|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/ce170094ba8b6ecf0228994ae20046d4decd4e47)|
|2024-07-22|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/d983591076e2211d2592fc576f2893c13f8a7ffe)|
|2024-08-02|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/3b2e1a575e4c39ff2e903692fc2dbed58d0828fb)|
|2024-08-05|윤상혁|[PR](https://github.com/benxcorp/databricks/commit/8793afc5490510a264cccde00409a7a9de63f896)|
  
  
# TABLE NOTICE
  
### 테이블 개요

* **테이블 목적**: 위버스 멤버십 가입 정보 및 구매 정보, 유저 정보, 멤버십 상품 정보를 통합한 히스토리 테이블
* **데이터 레벨**: TRANSACTIONAL DATA
* **파티션 키**: `part_art_id`, `part_date`
* **주요 키**: `fc_num`

### 테이블 특징

* 각 멤버십 가입 건에 대한 상세 정보를 담고 있으며, 멤버십 가입, 만료, 갱신, 복구, 취소 등 모든 히스토리를 기록
* 멤버십 종류, 가입 시각, 만료 시각, 구매 시각, 유저 정보, 상품 정보, 멤버십 상태, 구매 상태, 탈퇴 사유 등 다양한 정보를 제공
* 멤버십 복구 정보를 별도로 기록하여 멤버십 복구 건에 대한 분석 가능
* 멤버십 구매 횟수, 갱신으로 인한 추가 일수 등 멤버십 구매 패턴 분석 가능
* 유저의 최초 가입 시각(멤버십 서비스 전체 기준, 아티스트 기준, 샵 기준) 정보 제공

### 데이터 추출 및 생성 과정

1. **주요 데이터 소스**:
    * `wev_prod.we_mart.ods_fc_member`: 멤버십 현황 정보 (현재 상태 정보만 확인 가능)
    * `membership.member_history`: 멤버십 히스토리 정보 (과거 구매 건 확인)
    * `wev_prod.we_mart.ods_ws_order_sheet`: 주문 정보
    * `wev_prod.we_mart.ods_ws_order_item`: 주문 상품 정보
    * `wev_prod.we_mart.ods_fc_member_confirm_purchase_history`: 멤버십 구매 확정 정보
    * `wev_prod.we_mart.ods_fc_member_membership_history`: 멤버십 가입/만료 타입 정보
    * `wev_prod.we_mart.ods_ws_user`: 유저 정보
    * `wev_prod.we_mart.ws_user_ctry_history`: 유저 국가 정보 히스토리
    * `wev_prod.membership.membership`: 멤버십 상품 정보
    * `wev_prod.membership.artist_shop_version`: 멤버십 상품 버전 정보
    * `wev_prod.membership.artist`: 아티스트 정보
    * `wev_prod.membership.membership_version`: 멤버십 버전 정보
    * `wev_prod.membership.membership_shop`: 멤버십 상품 판매 샵 정보
    * `wev_prod.membership.membership_type`: 멤버십 상품 타입 정보
    * `wev_prod.we_mart.we_artist`: 아티스트 정보
    * `wev_prod.we_meta.we_country`: 국가 정보
    * `wev_prod.membership.member_privacy_history`: 유저 개인정보 히스토리
2. **데이터 전처리**:
    * `ods_fc_member` 테이블과 `member_history` 테이블을 합쳐 멤버십 가입 히스토리 정보 생성
    * SMEJ 이관 유저의 가입 시각 정보를 이관 시점으로 수정
    * 멤버십 만료 시각을 `deactivated_at`, `ended_at`, `updated_at` 등을 고려하여 정확하게 계산
    * `member_history` 테이블에만 존재하는 데이터는 `DEACTIVATED` 상태로 처리
    * 멤버십 첫 구매 시각 정보 생성
    * 각 멤버십 번호에 대한 가장 최근 상태만 추출
3. **데이터 통합**:
    * 멤버십 가입 히스토리 정보, 주문 정보, 유저 정보, 멤버십 상품 정보 등을 `left join`으로 결합
    * 멤버십 복구 정보를 `left join`으로 추가
    * 멤버십 구매 타입, 탈퇴 사유 등을 계산하여 추가
    * 멤버십 구매 횟수, 갱신으로 인한 추가 일수 등을 계산하여 추가
    * 유저의 최초 가입 시각(멤버십 서비스 전체 기준, 아티스트 기준, 샵 기준) 정보를 계산하여 추가
4. **최종 테이블 생성**:
    * 위 단계에서 생성된 데이터를 `we_mart.ws_fc_user_history` 테이블에 저장
    * `part_art_id`와 `part_date`를 파티션 키로 사용

### 테이블 활용 가이드

* **주요 활용**:
    * 위버스 멤버십 가입 및 구매 패턴 분석
    * 멤버십 만료 원인 분석
    * 유저의 멤버십 이용 행태 분석
    * 멤버십 상품별 구매 정보 분석
    * 멤버십 복구 건 분석
* **조인 시 유의사항**:
    * `we_member_id`는 위버스 플랫폼 전체의 유저 ID로, `wv_user_id` (Weverse community) 또는 `ws_user_id` (Weverse Shop)와 일치하지 않을 수 있음
    * `fc_num`은 멤버십 회원번호로, 다른 테이블의 유저 ID와 일치하지 않음
    * `part_date`는 파티션 일자로, 다른 테이블의 `part_date`와 일치하는지 확인

### 추가 정보

* `we_member_id`는 위버스 플랫폼 전체의 유저 ID로, 다른 서비스(예: Weverse community, Weverse Shop)의 유저 ID와 일치하지 않을 수 있음
* `fc_num`은 멤버십 회원번호로, 다른 테이블의 유저 ID와 일치하지 않음
* `auth_ctry_code`와 `auth_ctry_name`은 유저의 전화번호 인증 국가 정보를 나타냄
* `is_restore_item`과 `is_cx_by_restore`는 멤버십 복구 여부를 나타냄
* `first_create_dt`, `shop_first_create_dt`, `tot_first_create_dt`는 유저의 최초 가입 시각 정보를 나타냄
* `raw_expired_at`는 검증용 만료일자로, `expired_at`와 비교하여 정확성을 확인할 수 있음  
---
# COLUMN INFO

|#|Column Name|Data Type|Comment|
| :--- | :--- | :--- | :--- |
|0|we_member_id|bigint|we_member_id|
|1|user_id|bigint|위버스샵 회원 id|
|2|user_status|string|위버스샵 계정 상태|
|3|birth_date|string|생년월일|
|4|sex|string|성별|
|5|first_ip_ctry|string|최초 접속 국가|
|6|we_art_id|int|we_art_id|
|7|we_art_name|string|we_art_name|
|8|comm_id|bigint|위버스 커뮤니티 id|
|9|ws_art_id|bigint|위버스샵 아티스트 id|
|10|ws_label_id|bigint|위버스샵 레이블 id|
|11|shop|string|멤버십 구매 SHOP|
|12|fc_id|bigint|멤버십 id|
|13|fc_name|string|멤버십명|
|14|fc_ver|int|멤버십 버전|
|15|fc_type|string|멤버십 종류|
|16|fc_num|string|멤버십 회원번호|
|17|create_dt|timestamp|멤버십 구매 시간|
|18|no_refund_dt|timestamp|멤버십 구매확정 시간|
|19|expire_dt|timestamp|멤버십 만료 시간|
|20|start_dt|timestamp|멤버십 유효기간 시작 시간|
|21|end_dt|timestamp|멤버십 유효기간 만료예정 시간|
|22|ord_ip_ctry|string|멤버십 구매시점 ip 기준 국가|
|23|auth_call_code|int|전화번호 인증번호|
|24|auth_ctry_code|array<string>|전화번호 인증 국가코드|
|25|auth_ctry_name|array<string>|전화번호 인증 국가명|
|26|sale_id|bigint|sale_id|
|27|ord_sheet_id|bigint|order_sheet_id|
|28|ord_sheet_num|bigint|order_sheet_number 주문번호|
|29|pur_type|string|멤버십 구매 종류|
|30|fc_status|string|멤버십 가입상태|
|31|ord_status|string|멤버십 구매상태|
|32|withdraw_status|string|멤버십 만료 상세 내용|
|33|pur_seq|int|멤버십 구매 횟수|
|34|extra_day|int|갱신 혜택으로 받은 추가 일자|
|35|is_restore_item|int|복구된 멤버십 유무|
|36|is_cx_by_restore|int|멤버십 복구로 인한 취소 유무|
|37|restore_dt|timestamp|운영으로 인해 과거 멤버십으로 복구한 시간|
|38|first_create_dt|timestamp|아티스트 멤버십 첫가입일자|
|39|shop_first_create_dt|timestamp|샵기준 멤버십 첫가입일자|
|40|tot_first_create_dt|timestamp|위버스샵 멤버십 첫가입일자|
|41|raw_expired_at|timestamp|검증용 만료일자(from order_item)|
|42|run_timestamp|timestamp|적재 시간|
|43|part_date|string|파티션 일자|
|44|part_art_id|bigint|파티션 아티스트 id|
  
    
---
# HOW TO USE
  
No content.  
---
# PIPELINE INFO

## ⌛️ BATCH

### DAG: `analytics_ws_mart_daily`

### Update Interval: DAILY

### Update Type: APPEND

## 📍 LINK URLs

### Github: [Source Code](https://github.com/benxcorp/databricks/blob/main/src/data_analytics/mart/we_mart/ws_fc_user_history.py)

### Airflow: [DAG](https://github.com/benxcorp/dp-airflow/blob/main/dags/utils/dynamic_dag/wev/task_list/analytics_ws_mart_daily.py)
  
    
---
# DEPENDENCIES

## 👨‍👩‍👧‍👦 Up/Downstream Table List

|Upstream Tables|Downstream Tables|
| :--- | :--- |
|membership.artist|we_mart.ph_subscr|
|membership.artist_shop_version|we_mart.stats_ws_d_fc_join|
|membership.member_history|we_mart.stats_ws_d_fc_kit_pur|
|membership.member_privacy_history|we_mart.stats_ws_d_fc_shop_cross_join|
|membership.membership|we_mart.stats_ws_m_fc_jp_sm|
|membership.membership_shop|we_mart.stats_wv_d_posting_activity|
|membership.membership_type|we_mart.tmp_val_fc_kit_pur|
|membership.membership_version|we_mart.view_ws_ship_status_fc_kit|
|test.fc_val2|we_mart.wa_sess_daily|
|we_mart.ods_fc_member|we_mart.wa_user_album_reg|
|we_mart.ods_fc_member_confirm_purchase_history|we_mart.we_fan_apply|
|we_mart.ods_fc_member_membership_history|we_mart.we_order|
|we_mart.ods_ws_order_item|we_mart.we_user_demo_log|
|we_mart.ods_ws_order_sheet|we_mart.we_user_dic_engaged_by_project|
|we_mart.ods_ws_user|we_mart.ws_fc_user_by_ord|
|we_mart.we_artist|we_mart.ws_fc_user_history|
|we_mart.ws_fc_user_history|we_mart.ws_fc_user_update|
|we_mart.ws_user_ctry_history|we_mart.ws_order|
|we_meta.we_country|we_mart.ws_sess_daily|
| |we_mart.ws_user_buy|
| |we_mart.ws_user_daily|
| |we_mart.wv_comm_user|
| |we_mart.wv_dm_msg_fan|
| |we_mart.wv_dm_subscr_daily|
| |we_mart.wv_dm_subscr_history|
| |we_mart.wv_fanletter_consume|
| |we_mart.wv_fanletter_voucher|
| |we_mart.wv_live_play|
| |we_mart.wv_media_reaction|
| |we_mart.wv_order|
| |we_mart.wv_post_reaction|
| |we_mart.wv_sess_daily|

## 🐤 Downstream Tables Info
  
### Downstream Tables
- **`we_mart.ws_fc_user_update`**: FC멤버십 전체 회원 정보 snapshot. `ws_fc_user_history` 테이블에서 최신 정보를 가져와서 `fc_num` 컬럼을 기준으로 업데이트 진행. 만료된 회원은 삭제 처리.
    - `ws_fc_user_history` 테이블에서 `part_date` 컬럼을 기준으로 최신 데이터를 가져와서 `fc_num` 컬럼을 기준으로 `ws_fc_user_update` 테이블과 join 진행.
    - `ws_fc_user_history` 테이블에서 `fc_num` 컬럼을 기준으로 최신 데이터를 가져와서 `ws_fc_user_update` 테이블에 merge into. 만료된 회원은 삭제 처리.
- **`wev_prod.we_mart.ws_fc_user_by_ord`**: 주문번호별 멤버십 유효기간. `ws_fc_user_history` 테이블에서 주문번호와 멤버십 번호를 기준으로 데이터를 가져와서 `ws_fc_user_by_ord` 테이블에 저장.
    - `ws_fc_user_history` 테이블에서 `ord_sheet_num` 컬럼을 기준으로 데이터를 가져와서 `ws_fc_user_by_ord` 테이블에 merge into. 만료된 회원은 삭제 처리.
    - `ws_fc_user_history` 테이블에서 `ord_sheet_num` 컬럼을 기준으로 데이터를 가져와서 `ws_fc_user_by_ord` 테이블에 저장.

### Downstream View Tables
- **`wev_prod.we_mart.view_ws_ship_status_fc_kit`**: weverseshop 멤버십 키트 배송 상태. `ws_fc_user_history` 테이블에서 멤버십 정보를 가져와서 `weverseshop` 테이블의 키트 주문 정보와 join.
    - `ws_fc_user_history` 테이블에서 `fc_id` 컬럼을 기준으로 멤버십 정보를 가져와서 `weverseshop.order_item` 테이블과 join. `weverseshop.order_item` 테이블의 `goods_code` 컬럼과 `ws_fc_user_history` 테이블의 `fc_id` 컬럼을 비교하여 키트 주문 정보를 추출.
    - `ws_fc_user_history` 테이블에서 `fc_id` 컬럼을 기준으로 멤버십 정보를 가져와서 `weverseshop.order_item` 테이블과 join. `weverseshop.order_item` 테이블의 `goods_code` 컬럼과 `ws_fc_user_history` 테이블의 `fc_id` 컬럼을 비교하여 키트 주문 정보를 추출.
- **`wev_prod.we_mart.stats_ws_d_fc_shop_cross_join`**: 일별 멤버십 샵 중복가입자 통계. `ws_fc_user_history` 테이블에서 `we_member_id`, `fc_id`, `shop` 컬럼을 기준으로 데이터를 가져와서 중복 가입 여부를 판단.
    - `ws_fc_user_history` 테이블에서 `we_member_id` 컬럼을 기준으로 데이터를 가져와서 `shop` 컬럼을 기준으로 중복 가입 여부를 판단.
    - `ws_fc_user_history` 테이블에서 `we_member_id` 컬럼을 기준으로 데이터를 가져와서 `shop` 컬럼을 기준으로 중복 가입 여부를 판단.  
---