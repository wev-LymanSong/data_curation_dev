
we_mart.we_order
================

# BASIC INFO

|**About**| 담당자 수기 입력 필요 |
| :--- | :--- |
|**Database**|**we_mart**|
|**Table Type**|MART PRIMARY|
|**Partitioned by**|`part_date`|
|**Created/ Last Updated At**|2022-01-13 / 2024-03-19|
|**Created By**|박상민|
|**Last Updated By**|이현지|
|**Collaborators**|이현지[13], 송재영[11], 박상민[4], 박상민[2], 이현지[1], 사공재현[1], 구민서[1]|
  
#### Change History
|**Date**|**By**|**LINK**|
| :--- | :--- | :--- |
|2022-01-13|박상민|[PR](https://github.com/benxcorp/databricks/commit/769d43d41e4da8040abf2b0d7ef59e241ab0a35f)|
|2022-01-20|박상민|[PR](https://github.com/benxcorp/databricks/commit/1c2504b9d34d03bcaf6518ca95bbd52925d63819)|
|2022-06-09|박상민|[PR](https://github.com/benxcorp/databricks/commit/0c359b2241b78ea4e23c53ee253ab6551e536ef5)|
|2022-06-15|박상민|[PR](https://github.com/benxcorp/databricks/commit/26a11612f425424f04ad505b268c2f6eb5d59dd9)|
|2022-07-01|이현지|[PR](https://github.com/benxcorp/databricks/commit/91fd736059249806fe2a1674425420850a36b514)|
|2022-07-18|박상민|[PR](https://github.com/benxcorp/databricks/commit/eff03c3c3b1f8297352b342a7cdc30f5f8a036b7)|
|2022-07-19|박상민|[PR](https://github.com/benxcorp/databricks/commit/bbb675e20da2d62338d20a67dde3f8bbcc1abe1b)|
|2022-07-29|송재영|[PR](https://github.com/benxcorp/databricks/commit/842acd4f631ce140facb374d0e6581c3758d72e6)|
|2022-10-31|송재영|[PR](https://github.com/benxcorp/databricks/commit/fa333e0bf4b7a0eb2ac9c7884a99c3f5c62c183c)|
|2022-11-14|송재영|[PR](https://github.com/benxcorp/databricks/commit/83e303dfaf21f61db5e8ffddaea837dfde1e6f1d)|
|2022-12-02|이현지|[PR](https://github.com/benxcorp/databricks/commit/4637c90fe15b8860a342ec2552bc00fa5149f1e9)|
|2022-12-06|이현지|[PR](https://github.com/benxcorp/databricks/commit/dd0af994404f0111149538b384315ece6d7a8e5b)|
|2022-12-09|송재영|[PR](https://github.com/benxcorp/databricks/commit/e43e9fd32e8ed8e6ff0309723f91270398a2d333)|
|2022-12-09|구민서|[PR](https://github.com/benxcorp/databricks/commit/bd183779c84e616084e05627330a1c8b98ca44bd)|
|2023-03-31|이현지|[PR](https://github.com/benxcorp/databricks/commit/636146f62f6b487f40c718882bb80a2e774781de)|
|2023-04-27|송재영|[PR](https://github.com/benxcorp/databricks/commit/07154e9ff926d600423820ea8e605cf5a569a1cb)|
|2023-05-23|이현지|[PR](https://github.com/benxcorp/databricks/commit/2b98f63e0c0a65834237e3ed9808af8da61e425f)|
|2023-05-25|이현지|[PR](https://github.com/benxcorp/databricks/commit/3d48a4e0b46d47f1394ee30af347edb3d98e6ac6)|
|2023-05-25|이현지|[PR](https://github.com/benxcorp/databricks/commit/1225de5dde14db5b9ada91567be0da4d60b4235a)|
|2023-06-12|송재영|[PR](https://github.com/benxcorp/databricks/commit/1236bdde805c52f4442238bbdb505c34127594e6)|
|2023-06-12|송재영|[PR](https://github.com/benxcorp/databricks/commit/757d2333031d5421e357adda0cb5501ead686eda)|
|2023-06-13|송재영|[PR](https://github.com/benxcorp/databricks/commit/a3737d87c4d39205fd1038796ac4291172e8221f)|
|2023-06-13|사공재현|[PR](https://github.com/benxcorp/databricks/commit/0aef31741cb8e1ed5c58f64aec7875a73fd58385)|
|2023-06-14|이현지|[PR](https://github.com/benxcorp/databricks/commit/ea0a2b07133ea03af984e9076694555f69cfbb89)|
|2023-06-16|송재영|[PR](https://github.com/benxcorp/databricks/commit/1b6b674ca6007651ea11e31bd35bff2545c90280)|
|2023-06-22|이현지|[PR](https://github.com/benxcorp/databricks/commit/f9fc5a1bea941b11d08d2a68b499446f39249c1d)|
|2023-09-13|이현지|[PR](https://github.com/benxcorp/databricks/commit/c881a709360da4152072f58a5b1fa27f1b5ad6ae)|
|2023-11-09|송재영|[PR](https://github.com/benxcorp/databricks/commit/352bb2c1389b350e07eec8912cdb846ed51ccb76)|
|2023-11-16|송재영|[PR](https://github.com/benxcorp/databricks/commit/2aa87eafd6f19e6d9ab56ec6f95322916f0fd9ca)|
|2023-12-05|이현지|[PR](https://github.com/benxcorp/databricks/commit/79850bbd7de7ea1a3a3b9eb1b81379444a8d2235)|
|2024-01-18|이현지|[PR](https://github.com/benxcorp/databricks/commit/52477c381ba65d15215cd51759db29588027fee6)|
|2024-03-19|이현지|[PR](https://github.com/benxcorp/databricks/commit/498fef12c553ef095d33b8d20e2e1f49ca085bbc)|
|2024-03-19|이현지|[PR](https://github.com/benxcorp/databricks/commit/6718174f92d2114266e78a57117d14de9ed3001a)|
  
  
# TABLE NOTICE
  
### 테이블 개요

* **테이블 목적**: Weverse 플랫폼의 모든 서비스 (Weverse Shop, Weverse, Phoning)의 주문 데이터를 통합하여 분석 및 인사이트 도출을 위한 데이터 제공
* **데이터 레벨**: TRANSACTIONAL DATA
* **파티션 키**: `part_date`
* **주요 키**: `we_member_id`, `product_source`, `key_date`, `ord_item_id`, `sale_id`

### 테이블 특징

* Weverse Shop(`WS`), Weverse(`WV`), Phoning(`PH`) 서비스의 주문 데이터를 하나의 테이블로 통합하여 분석 편의성 향상
* 각 서비스별 주문 정보 외에 멤버십 정보(`is_fc`, `fc_id`, `fc_name`)를 포함하여 멤버십과 관련된 분석 가능
* `product_type` 컬럼을 통해 상품 카테고리 분류(`MEMBERSHIP`, `LIVE_TICKET`, `ALBUM`, `BOOK`, `CLOTHING`, `DVD`, `VOD`, `LIGHT_STICK`, `POD`, `MD`)

### 데이터 추출 및 생성 과정

1.  **주요 데이터 소스**:
    *   `we_mart.ws_order`: Weverse Shop 주문 데이터
    *   `we_mart.wv_order`: Weverse 주문 데이터
    *   `we_mart.ph_subscr`: Phoning 주문 데이터
    *   `we_mart.ws_fc_user_history`: Weverse Shop 멤버십 정보
2.  **데이터 전처리**:
    *   각 서비스별 주문 데이터에서 필요한 컬럼만 추출
    *   `key_date` 컬럼을 기준으로 각 서비스별 주문 데이터를 `full join`하여 통합
    *   `goods_cat` 컬럼을 기반으로 `product_type` 컬럼 생성
    *   `ws_fc_user_history` 테이블을 사용하여 멤버십 정보(`fc_id`, `fc_name`)를 `left join`하여 통합
3.  **데이터 통합**:
    *   각 서비스별 주문 데이터를 `unionByName`을 사용하여 통합
    *   `we_member_id`, `we_art_id`를 기준으로 멤버십 정보를 `first` 함수를 사용하여 가장 최근 멤버십 정보를 가져옴
4.  **최종 테이블 생성**:
    *   통합된 데이터를 `we_mart.we_order` 테이블에 저장
    *   `part_date` 컬럼을 파티션 키로 사용하여 데이터를 분할 저장

### 테이블 활용 가이드

* **주요 활용**:
    *   Weverse 플랫폼 전체 주문 데이터 분석
    *   서비스별 주문 현황 비교 분석
    *   멤버십과 관련된 주문 분석
    *   상품 카테고리별 주문 분석
* **조인 시 유의사항**:
    *   `we_mart.we_artist` 테이블과 `we_art_id` 컬럼을 사용하여 아티스트 정보를 조인
    *   `we_mart.we_goods` 테이블과 `goods_option_id` 컬럼을 사용하여 상품 정보를 조인
    *   `we_mart.we_member` 테이블과 `we_member_id` 컬럼을 사용하여 회원 정보를 조인

### 추가 정보

* `run_timestamp` 컬럼은 데이터가 로딩된 시간을 나타냄
* `we_pay_seq` 컬럼은 `we_member_id`, `is_pay`를 기준으로 결제 순번을 나타냄
* `cx_pay_dt` 컬럼은 취소 건의 결제 일시를 나타냄
* `part_date` 컬럼을 파티션 키로 사용하여 데이터를 분할 저장함으로써 쿼리 성능 향상  
---
# COLUMN INFO

|#|Column Name|Data Type|Comment|
| :--- | :--- | :--- | :--- |
|0|key_date|date|기준일자|
|1|we_member_id|bigint|we_member_id|
|2|ws_user_id|bigint|ws_user_id|
|3|wv_user_id|bigint|wv_user_id|
|4|ph_user_id|bigint|ph_user_id|
|5|product_source|string|서비스구분(WS,WV,PH)|
|6|is_pay|int|결제여부|
|7|is_cx|int|취소여부|
|8|is_fc|int|결제/취소시점 멤버십여부|
|9|ctry_code|string|결제시점 IP국가코드|
|10|pay_dt|timestamp|결제일시|
|11|cx_dt|timestamp|취소일시|
|12|cx_pay_dt|timestamp|취소건 결제일시|
|13|currency_code|string|결제통화|
|14|pay_amt_krw|double|판매액(KRW)|
|15|pay_amt|double|판매액|
|16|pay_qty|bigint|판매수량|
|17|pay_album_qty|bigint|판매앨범수량|
|18|cx_amt_krw|double|취소/환불액(KRW)|
|19|cx_amt|double|취소/환불액|
|20|cx_qty|bigint|취소/환불수량|
|21|cx_album_qty|bigint|취소/환불앨범수량|
|22|we_art_id|int|we_art_id|
|23|we_art_name|string|we_art_name|
|24|shop|string|shop|
|25|product_type|string|product_type|
|26|ord_sheet_number|bigint|ord_sheet_number|
|27|transaction_id|string|transaction_id|
|28|ord_item_id|bigint|ord_item_id|
|29|sale_stock_id|bigint|sale_stock_id|
|30|sale_id|bigint|sale_id|
|31|sale_price|double|상품금액|
|32|sale_currency_code|string|상품통화|
|33|wbs_code|string|wbs_code|
|34|sap_code|string|sap_code|
|35|pay_system|string|pay_system|
|36|pay_method|string|pay_method|
|37|goods_code|string|goods_code|
|38|goods_option_id|string|goods_option_id|
|39|goods_option_code|string|goods_option_code|
|40|goods_name|string|상품명|
|41|goods_option_name|string|상품옵션명|
|42|goods_upr_cat_id|bigint|상위카테고리ID|
|43|goods_lwr_cat_id|bigint|하위카테고리ID|
|44|goods_upr_cat_name|string|상위카테고리명|
|45|goods_lwr_cat_name|string|하위카테고리명|
|46|dur_type|string|dur_type|
|47|dur_unit|string|구매상품 유형에 따른 단위|
|48|dur_value|int|dur_value|
|49|promotion_type|string|promotion_type|
|50|promotion_unit|string|이벤트 타입에 따른 단위|
|51|promotion_value|int|promotion_value|
|52|album_qty|int|앨범수량|
|53|logi_cat|string|물류카테고리|
|54|ship_ctry_code|string|배송국가|
|55|ship_cost_type|string|배송구분|
|56|device_type|string|device_type|
|57|trade_co_name|string|거래처|
|58|pay_card_type|string|결제카드타입|
|59|pay_mobile_provider|string|결제모바일통신사|
|60|pay_seq|bigint|각 서비스별 주문순번|
|61|we_pay_seq|bigint|전체 서비스 주문순번|
|62|fc_id|bigint|결제/취소시점 멤버십ID|
|63|fc_name|string|결제/취소시점 멤버십명|
|64|part_date|string|part_date|
|65|run_timestamp|timestamp|run_timestamp|
  
    
---
# HOW TO USE
  
No content.  
---
# PIPELINE INFO

## ⌛️ BATCH

### DAG: `analytics_we_mart_priority_daily`

### Update Interval: DAILY

### Update Type: OVERWRITE

## 📍 LINK URLs

### Github: [Source Code](https://github.com/benxcorp/databricks/blob/main/src/data_analytics/mart/we_mart/we_order.py)

### Airflow: [DAG](https://github.com/benxcorp/dp-airflow/blob/main/dags/utils/dynamic_dag/wev/task_list/analytics_we_mart_priority_daily.py)
  
    
---
# DEPENDENCIES

## 👨‍👩‍👧‍👦 Up/Downstream Table List

|Upstream Tables|Downstream Tables|
| :--- | :--- |
|product.product|we_mart.stats_we_d_ord_new|
|we_mart.ph_subscr|we_mart.stats_we_d_order_fc|
|we_mart.ws_fc_user_history|we_mart.stats_we_d_pay|
|we_mart.ws_goods_stock|we_mart.stats_we_m_cluster_arppu|
|we_mart.ws_order|we_mart.stats_we_m_cluster_ord|
|we_mart.wv_order|we_mart.stats_we_m_cluster_prd|
|we_meta.we_digital_product|we_mart.stats_we_w_order_first_seq|
|we_meta.we_media_product|we_mart.stats_ws_d_bulk_user_sales|
| |we_mart.stats_ws_d_ord_cx|
| |we_mart.stats_ws_d_ord_cx_type|
| |we_mart.stats_ws_d_ord_sale|
| |we_mart.stats_wv_h_digital_prod_sale|
| |we_mart.we_sale|
| |we_mart.ws_d_bulk_user_sales|
| |we_meta.we_artist_evt|

## 🐤 Downstream Tables Info
  
`
### Downstream Tables
- **`we_mart.stats_we_d_ord`**: 위버스 + 위버스샵 판매 통계
    - `we_mart.we_order` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 판매 및 취소 정보를 집계
    - `we_mart.wv_sess_daily` 및 `we_mart.ws_user_daily` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 방문 정보를 집계하여 `we_mart.we_order` 테이블과 조인
    - 일별 판매량, 취소량, 매출액, 순매출액, 구매자 수, 방문자 수를 계산
    - 특정 아티스트, 서비스, 상품 유형, 국가, 날짜 범위를 지정하여 데이터 추출 가능
- **`we_mart.stats_we_d_ord_new`**: 전체 서비스 order stats
    - `we_mart.we_order` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 판매 및 취소 정보를 집계
    - `we_mart.stats_we_d_visit_new` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 방문 정보를 집계하여 `we_mart.we_order` 테이블과 조인
    - 일별 판매량, 취소량, 매출액, 순매출액, 구매자 수, 신규 구매자 수, 재구매 유저 수, 방문자 수를 계산
    - 특정 아티스트, 서비스, 상품 유형, 국가, 날짜 범위를 지정하여 데이터 추출 가능
- **`we_mart.stats_ws_d_ord_sale`**: 위버스샵 매출 통계
    - `we_mart.we_order` 테이블을 사용하여 위버스샵 상품별 일별 판매 및 취소 정보를 집계
    - `weverseshop.order_sheet` 테이블을 사용하여 위버스샵 주문 정보를 `we_mart.we_order` 테이블과 조인
    - `we_meta.currency_rate` 테이블을 사용하여 위버스샵 주문 정보의 화폐 단위를 KRW로 변환
    - 일별 판매량, 취소량, 매출액, 순매출액, 구매자 수, 방문자 수, 가입자 수, 가입 당일 구매자 수를 계산
    - 특정 아티스트, 상품 유형, 국가, 날짜 범위를 지정하여 데이터 추출 가능
- **`we_mart.stats_we_d_order_fc`**: 위버스샵 방문 퍼널
    - `we_mart.we_order` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 판매 및 취소 정보를 집계
    - `we_mart.ws_user_daily` 및 `we_mart.wv_sess_daily` 테이블을 사용하여 아티스트, 서비스, 상품 유형별 일별 방문 정보를 집계하여 `we_mart.we_order` 테이블과 조인
    - 멤버십 가입 여부를 기준으로 일별, 주별, 월별 구매자 수 및 방문자 수를 계산
    - 특정 아티스트, 서비스, 상품 유형, 국가, 날짜 범위를 지정하여 데이터 추출 가능
- **`we_mart.stats_ws_d_ord_cx_type`**: 위버스샵 취소 유형별 취소 건수
    - `we_mart.we_order` 테이블을 사용하여 위버스샵 상품별 일별 취소 정보를 집계
    - `we_mart.ws_ord_cx_reason` 테이블을 사용하여 위버스샵 주문 취소 사유 정보를 `we_mart.we_order` 테이블과 조인
    - `we_meta.we_cancel_type` 테이블을 사용하여 위버스샵 주문 취소 유형 정보를 `we_mart.we_order` 테이블과 조인
    - `we_meta.lang_code` 테이블을 사용하여 위버스샵 주문 취소 사유 언어 정보를 `we_mart.we_order` 테이블과 조인
    - 일별, 주별, 월별 취소 건수, 취소 사유별 취소 건수를 계산
    - 특정 아티스트, 상품 유형, 국가, 날짜 범위를 지정하여 데이터 추출 가능

### Downstream View Tables
- **`we_mart.view_we_country`**: 국가 코드 정보
    - `we_meta.we_country` 테이블을 사용하여 국가 코드 정보를 조회
    - 국가 코드, 국가 이름, 지역 유형, 지역 유형 (비즈니스), 국가 이름 (영어) 정보를 제공
    - 특정 국가 코드, 국가 이름, 지역 유형을 지정하여 데이터 추출 가능
- **`we_mart.view_we_artist`**: 아티스트 정보
    - `we_mart.we_artist` 테이블을 사용하여 아티스트 정보를 조회
    - 아티스트 ID, 아티스트 이름, 아티스트 이미지 URL, 아티스트 프로필 URL 정보를 제공
    - 특정 아티스트 ID, 아티스트 이름을 지정하여 데이터 추출 가능
- **`we_mart.view_we_user`**: 유저 정보
    - `we_mart.we_user` 테이블을 사용하여 유저 정보를 조회
    - 유저 ID, 유저 이름, 유저 생성 날짜, 유저 업데이트 날짜, 유저 국가 코드, 유저 이메일 주소, 유저 프로필 이미지 URL 정보를 제공
    - 특정 유저 ID, 유저 이름, 유저 생성 날짜를 지정하여 데이터 추출 가능
- **`we_mart.view_we_product`**: 상품 정보
    - `we_mart.we_product` 테이블을 사용하여 상품 정보를 조회
    - 상품 ID, 상품 이름, 상품 카테고리, 상품 가격, 상품 이미지 URL, 상품 설명 정보를 제공
    - 특정 상품 ID, 상품 이름, 상품 카테고리를 지정하여 데이터 추출 가능
- **`we_mart.view_we_order`**: 주문 정보
    - `we_mart.we_order` 테이블을 사용하여 주문 정보를 조회
    - 주문 ID, 주문 날짜, 주문 금액, 주문 상태, 주문 유형, 주문 국가 코드, 주문 상품 ID, 주문 상품 수량 정보를 제공
    - 특정 주문 ID, 주문 날짜, 주문 금액, 주문 상태를 지정하여 데이터 추출 가능  
---